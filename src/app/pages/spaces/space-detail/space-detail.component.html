<div class="page-transition">
  <!-- Hero Section -->
  <section class="py-5 bg-light position-relative overflow-hidden">
    <div class="container position-relative z-10">
      <div class="row justify-content-center text-center py-5">
        <div class="col-lg-8">
          <h1 class="display-4 fw-bold mb-4">Détails de l'espace</h1>
          <p class="lead text-muted mb-5">
            Découvrez tous les détails de notre espace de coworking : un lieu
            pensé pour favoriser la collaboration, la créativité et la
            productivité. CoworkSpace vous propose un environnement moderne,
            flexible et parfaitement adapté aux exigences des professionnels
            d'aujourd'hui.
          </p>
          <div class="d-flex gap-3 justify-content-center">
            <button class="btn btn-primary btn-lg" routerLink="/spaces">
              Retour aux espaces
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="position-absolute top-0 start-0 w-100 h-50 bg-primary bg-opacity-5 rounded-circle blur"
    ></div>
  </section>

  <!-- Space Details Section -->
  <div class="container py-5">
    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-3">Chargement des détails de l'espace...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="alert alert-danger">
      {{ error }}
    </div>

    <!-- Space Details -->
    <div *ngIf="space && !loading" class="row g-4">
      <!-- Main Content -->
      <div class="col-lg-8">
        <!-- Space Name and Basic Info -->
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <h1 class="display-5 fw-bold">{{ space.name }}</h1>
            <div class="d-flex align-items-center gap-3 mb-3">
              <span class="badge bg-primary bg-opacity-10 text-primary">
                {{ space.pricePerHour | currency : "TND" : "symbol" : "1.2-2" }}
                /h
              </span>
              <span class="badge bg-primary bg-opacity-10 text-primary">
                {{ space.pricePerDay | currency : "TND" : "symbol" : "1.2-2" }}
                /j
              </span>
              <span class="text-muted">
                <i class="bi bi-people me-1"></i>
                Capacité: {{ space.capacity }} personnes
              </span>
            </div>
          </div>
          <span
            class="badge fs-6"
            [ngClass]="{
              'bg-success': space.isActive,
              'bg-danger': !space.isActive
            }"
          >
            {{ space.isActive ? "Disponible" : "Indisponible" }}
          </span>
        </div>

        <!-- Main Image -->
        <div class="mb-3">
          <img
            [src]="space.photo"
            class="img-fluid rounded-3 w-100"
            style="max-height: 400px; object-fit: cover"
            alt="{{ space.name }}"
            onerror="this.src='assets/images/default-space.jpg'"
          />
        </div>

        <!-- Gallery Thumbnails -->
        <div *ngIf="space.gallery?.length" class="mb-4">
          <div class="d-flex overflow-auto pb-2" style="scrollbar-width: thin">
            <div *ngFor="let image of space.gallery" class="flex-shrink-0 me-2">
              <img
                [src]="image"
                class="rounded-2 cursor-pointer"
                style="height: 80px; width: 120px; object-fit: cover"
                alt="Galerie {{ space.name }}"
                (click)="openImage(image)"
              />
            </div>
          </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="spaceDetailsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="description-tab"
              data-bs-toggle="tab"
              data-bs-target="#description"
              type="button"
              role="tab"
              aria-controls="description"
              aria-selected="true"
            >
              Description
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="amenities-tab"
              data-bs-toggle="tab"
              data-bs-target="#amenities"
              type="button"
              role="tab"
              aria-controls="amenities"
              aria-selected="false"
            >
              Équipements
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="reviews-tab"
              data-bs-toggle="tab"
              data-bs-target="#reviews"
              type="button"
              role="tab"
              aria-controls="reviews"
              aria-selected="false"
            >
              Avis
            </button>
          </li>
          <li
            class="nav-item"
            role="presentation"
            *ngIf="isLoggedIn() && subscriptionPlans.length > 0"
          >
            <button
              class="nav-link"
              id="subscriptions-tab"
              data-bs-toggle="tab"
              data-bs-target="#subscriptions"
              type="button"
              role="tab"
              aria-controls="subscriptions"
              aria-selected="false"
            >
              Abonnements
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="spaceDetailsTabsContent">
          <!-- Description Tab -->
          <div
            class="tab-pane fade show active"
            id="description"
            role="tabpanel"
            aria-labelledby="description-tab"
          >
            <p class="lead">{{ space.description }}</p>
          </div>

          <!-- Amenities Tab -->
          <div
            class="tab-pane fade"
            id="amenities"
            role="tabpanel"
            aria-labelledby="amenities-tab"
          >
            <div class="d-flex flex-column gap-2">
              <div
                *ngFor="let amenity of space.amenities"
                class="d-flex align-items-center gap-2"
              >
                <i class="bi bi-check-circle-fill text-primary"></i>
                <span>{{ amenity.name }}</span>
                <small class="text-muted" *ngIf="amenity.description"
                  >- {{ amenity.description }}</small
                >
              </div>
            </div>
          </div>

          <!-- Reviews Tab -->
          <div
            class="tab-pane fade"
            id="reviews"
            role="tabpanel"
            aria-labelledby="reviews-tab"
          >
            <!-- Review Form -->
            <div *ngIf="isLoggedIn()" class="card mb-4">
              <div class="card-body">
                <h3 class="h5 fw-bold mb-3">Donnez votre avis</h3>
                <form (ngSubmit)="submitReview()">
                  <div class="mb-3">
                    <label class="form-label">Note</label>
                    <div class="d-flex gap-1">
                      <span
                        *ngFor="
                          let filled of getStars(newReview.rating);
                          let i = index
                        "
                        (click)="newReview.rating = i + 1"
                        class="fs-4 cursor-pointer"
                      >
                        <i
                          [class]="
                            filled
                              ? 'bi bi-star-fill text-warning'
                              : 'bi bi-star text-warning'
                          "
                        ></i>
                      </span>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="reviewComment" class="form-label"
                      >Commentaire</label
                    >
                    <textarea
                      class="form-control"
                      id="reviewComment"
                      rows="3"
                      [(ngModel)]="newReview.comment"
                      name="comment"
                      required
                    ></textarea>
                  </div>
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="submittingReview"
                  >
                    <span
                      *ngIf="submittingReview"
                      class="spinner-border spinner-border-sm me-1"
                    ></span>
                    Envoyer l'avis
                  </button>
                </form>
              </div>
            </div>

            <!-- Reviews List -->
            <div *ngIf="reviews.length > 0; else noReviews">
              <div *ngFor="let review of reviews" class="card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <div>
                      <h4 class="h6 fw-bold mb-0">
                        {{ review.user?.name || "Anonyme" }}
                      </h4>
                      <small class="text-muted">{{
                        review.date | date : "mediumDate"
                      }}</small>
                    </div>
                    <div class="d-flex gap-1">
                      <span
                        *ngFor="let filled of getStars(review.rating)"
                        class="text-warning"
                      >
                        <i
                          [class]="filled ? 'bi bi-star-fill' : 'bi bi-star'"
                        ></i>
                      </span>
                    </div>
                  </div>
                  <p class="mb-0">{{ review.comment }}</p>
                </div>
              </div>
            </div>

            <ng-template #noReviews>
              <div class="alert alert-info">
                Aucun avis pour cet espace pour le moment.
              </div>
            </ng-template>
          </div>

          <!-- Subscriptions Tab -->
          <div
            class="tab-pane fade"
            id="subscriptions"
            role="tabpanel"
            aria-labelledby="subscriptions-tab"
            *ngIf="isLoggedIn() && subscriptionPlans.length > 0"
          >
            <div class="card mb-4">
              <div class="card-body">
                <h3 class="h4 fw-bold mb-3">Options d'abonnement</h3>
                <p class="text-muted mb-4">
                  Choisissez un plan d'abonnement pour bénéficier d'avantages
                  exclusifs et de tarifs préférentiels.
                </p>

                <div class="mb-4">
                  <label class="form-label">Périodicité</label>
                  <select
                    class="form-select"
                    [(ngModel)]="billingCycle"
                    (change)="selectedPlan = null"
                  >
                    <option value="MONTHLY">Mensuel</option>
                    <option value="YEARLY">Annuel (10% de réduction)</option>
                  </select>
                </div>

                <div class="row g-4">
                  <div class="col-md-6" *ngFor="let plan of subscriptionPlans">
                    <div
                      class="card h-100"
                      [class.border-primary]="selectedPlan?.type === plan.type"
                    >
                      <div class="card-body">
                        <h4 class="card-title">{{ plan.name }}</h4>
                        <h5 class="text-primary mb-3">
                          {{
                            billingCycle === "MONTHLY"
                              ? (plan.price | currency : "TND" : "symbol") +
                                "/mois"
                              : (plan.price * 12 * 0.9
                                  | currency : "TND" : "symbol") + "/an"
                          }}
                        </h5>
                        <p class="card-text">{{ plan.description }}</p>
                        <ul class="list-unstyled">
                          <li
                            *ngFor="let feature of plan.features"
                            class="mb-2"
                          >
                            <i
                              class="bi bi-check-circle-fill text-primary me-2"
                            ></i>
                            {{ feature }}
                          </li>
                        </ul>
                      </div>
                      <div class="card-footer bg-transparent">
                        <button
                          class="btn btn-outline-primary w-100"
                          (click)="selectPlan(plan)"
                          [class.btn-primary]="selectedPlan?.type === plan.type"
                        >
                          {{
                            selectedPlan?.type === plan.type
                              ? "Sélectionné"
                              : "Choisir ce plan"
                          }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="selectedPlan" class="mt-4 p-3 bg-light rounded">
                  <h5 class="fw-bold mb-3">Récapitulatif</h5>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Plan sélectionné:</span>
                    <span class="fw-bold">{{ selectedPlan.name }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Périodicité:</span>
                    <span class="fw-bold">{{
                      billingCycle === "MONTHLY" ? "Mensuelle" : "Annuelle"
                    }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Prix:</span>
                    <span class="fw-bold">{{
                      getPrice() | currency : "TND" : "symbol"
                    }}</span>
                  </div>
                  <hr />
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold">Total:</span>
                    <span class="fw-bold text-primary fs-5">{{
                      getPrice() | currency : "TND" : "symbol"
                    }}</span>
                  </div>
                  <button
                    class="btn btn-primary w-100 mt-3"
                    (click)="subscribe()"
                  >
                    Souscrire maintenant
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Booking Sidebar -->
      <div class="col-lg-4">
        <div class="card shadow-sm sticky-top" style="top: 20px">
          <div class="card-body">
            <h2 class="h4 fw-bold mb-4">Réserver cet espace</h2>

            <!-- Booking Success -->
            <div *ngIf="bookingSuccess" class="alert alert-success">
              Votre réservation a été effectuée avec succès!
            </div>

            <!-- Booking Error -->
            <div *ngIf="bookingError" class="alert alert-danger">
              {{ bookingError }}
            </div>

            <!-- Booking Form -->
            <form
              *ngIf="space.isActive && !bookingSuccess"
              (ngSubmit)="bookSpace()"
            >
              <!-- Date Picker -->
              <div class="mb-3">
                <label class="form-label">Date</label>
                <div class="input-group">
                  <input
                    class="form-control"
                    placeholder="yyyy-mm-dd"
                    ngbDatepicker
                    #d="ngbDatepicker"
                    [(ngModel)]="selectedDate"
                    name="date"
                    required
                  />
                  <button
                    class="btn btn-outline-secondary"
                    (click)="d.toggle()"
                    type="button"
                  >
                    <i class="bi bi-calendar"></i>
                  </button>
                </div>
              </div>

              <!-- Start Time -->
              <div class="mb-3">
                <label class="form-label">Heure de début</label>
                <ngb-timepicker
                  [(ngModel)]="selectedStartTime"
                  name="startTime"
                  required
                ></ngb-timepicker>
              </div>

              <!-- End Time -->
              <div class="mb-3">
                <label class="form-label">Heure de fin</label>
                <ngb-timepicker
                  [(ngModel)]="selectedEndTime"
                  name="endTime"
                  required
                ></ngb-timepicker>
              </div>

              <!-- Price Calculation -->
              <div class="mb-4 p-3 bg-light rounded">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Tarif horaire:</span>
                  <span class="fw-bold">{{
                    space.pricePerHour | currency : "TND" : "symbol" : "1.2-2"
                  }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Tarif journalier:</span>
                  <span class="fw-bold">{{
                    space.pricePerDay | currency : "TND" : "symbol" : "1.2-2"
                  }}</span>
                </div>
                <hr />
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Total estimé:</span>
                  <span class="fw-bold text-primary">
                    {{
                      calculateEstimatedPrice()
                        | currency : "TND" : "symbol" : "1.2-2"
                    }}
                  </span>
                </div>
              </div>

              <!-- Submit Button -->
              <button
                type="submit"
                class="btn btn-primary w-100"
                [disabled]="bookingInProgress"
              >
                <span
                  *ngIf="bookingInProgress"
                  class="spinner-border spinner-border-sm me-1"
                ></span>
                Réserver maintenant
              </button>
            </form>

            <!-- Not Available Message -->
            <div *ngIf="!space.isActive" class="alert alert-warning">
              Cet espace n'est pas disponible pour le moment.
            </div>

            <!-- Login Prompt -->
            <div *ngIf="!isLoggedIn()" class="alert alert-info mt-3">
              <p class="mb-2">
                Vous devez être connecté pour réserver cet espace.
              </p>
              <a routerLink="/signin" class="btn btn-sm btn-outline-primary"
                >Se connecter</a
              >
            </div>

            <!-- Subscription Quick Link -->
            <div
              *ngIf="isLoggedIn() && subscriptionPlans.length > 0"
              class="mt-4"
            >
              <div class="d-grid">
                <button
                  class="btn btn-outline-primary"
                  (click)="
                    showSubscriptionPlans = !showSubscriptionPlans;
                    selectTab('subscriptions')
                  "
                >
                  <i class="bi bi-credit-card me-2"></i>
                  Voir les options d'abonnement
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
