<div class="container-fluid py-4">
    <div class="mb-3">
        <a routerLink="/admin-dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour au tableau de bord
        </a>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Gestion des Abonnements</h5>
            <button class="btn btn-primary" (click)="openAddModal(addModal)">
                <i class="bi bi-plus-circle me-2"></i>Ajouter un abonnement
            </button>
        </div>
        
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Rechercher..." 
                           [(ngModel)]="searchTerm" (input)="applyFilters()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
                        <option value="ALL">Tous les statuts</option>
                        <option value="ACTIVE">Actif</option>
                        <option value="EXPIRED">Expiré</option>
                        <option value="CANCELLED">Annulé</option>
                        <option value="PENDING_PAYMENT">Paiement en attente</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" [(ngModel)]="typeFilter" (change)="applyFilters()">
                        <option value="ALL">Tous les types</option>
                        <option value="INDIVIDUAL">Individuel</option>
                        <option value="TEAM">Équipe</option>
                    </select>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Utilisateur</th>
                            <th>Type</th>
                            <th>Période</th>
                            <th>Prix</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let sub of filteredSubscriptions">
                            <td>{{sub.id}}</td>
                            <td>{{sub.name}}</td>
                            <td>{{sub.user.username}}</td>
                            <td>{{sub.type === 'INDIVIDUAL' ? 'Individuel' : 'Équipe'}}</td>
                            <td>
                                {{getFormattedDate(sub.startDate)}} - 
                                {{getFormattedDate(sub.endDate)}}
                            </td>
                            <td>{{sub.price}} TND</td>
                            <td>
                                <span class="badge rounded-pill {{getStatusClass(sub.status)}}">
                                    {{sub.status === 'ACTIVE' ? 'Actif' : 
                                    sub.status === 'EXPIRED' ? 'Expiré' : 
                                    sub.status === 'CANCELLED' ? 'Annulé' : 'Paiement en attente'}}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" (click)="openEditModal(editModal, sub)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" (click)="deleteSubscription(sub.id)" *ngIf="sub.status !== 'CANCELLED'">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" (click)="cancelSubscription(sub.id)" *ngIf="sub.status === 'ACTIVE'">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="filteredSubscriptions.length === 0">
                            <td colspan="8" class="text-center">Aucun abonnement trouvé</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<ng-template #addModal let-modal>
    <div class="modal-header">
        <h5 class="modal-title">{{currentSubscriptionId ? 'Modifier' : 'Ajouter'}} un abonnement</h5>
        <button type="button" class="btn-close" (click)="modal.hide()"></button>
    </div>
    <div class="modal-body">
        <form [formGroup]="subscriptionForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Utilisateur</label>
                    <select class="form-select" formControlName="userId">
                        <option value="">Sélectionner un utilisateur</option>
                        <option *ngFor="let user of users" [value]="user.id">{{user.username}} ({{user.email}})</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Plan d'abonnement</label>
                    <select class="form-select" (change)="onPlanSelect($event)">
                        <option value="">Sélectionner un plan</option>
                        <option *ngFor="let plan of subscriptionPlans" [value]="plan.type">
                            {{plan.name}} ({{plan.price}} TND - {{plan.billingCycle === 'MONTHLY' ? 'Mensuel' : 'Annuel'}})
                        </option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Type d'abonnement</label>
                    <select class="form-select" formControlName="type">
                        <option value="">Sélectionner un type</option>
                        <option value="INDIVIDUAL">Individuel</option>
                        <option value="TEAM">Équipe</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Cycle de facturation</label>
                    <select class="form-select" formControlName="billingCycle">
                        <option value="">Sélectionner un cycle</option>
                        <option value="MONTHLY">Mensuel</option>
                        <option value="YEARLY">Annuel</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Nom</label>
                    <input type="text" class="form-control" formControlName="name">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Prix (TND)</label>
                    <input type="number" class="form-control" formControlName="price" min="0" step="0.01">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Date de début</label>
                    <input type="date" class="form-control" formControlName="startDate">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Date de fin</label>
                    <input type="date" class="form-control" formControlName="endDate">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Espaces max</label>
                    <input type="number" class="form-control" formControlName="maxWorkspaces" min="1">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Heures incluses</label>
                    <input type="number" class="form-control" formControlName="includedHours" min="0">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Tarif horaire (TND)</label>
                    <input type="number" class="form-control" formControlName="hourlyRate" min="0" step="0.01">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.hide()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="saveSubscription()">
            {{currentSubscriptionId ? 'Mettre à jour' : 'Créer'}}
        </button>
    </div>
</ng-template>

<!-- Edit Modal (same as add modal) -->
<ng-template #editModal let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Modifier l'abonnement</h5>
        <button type="button" class="btn-close" (click)="modal.hide()"></button>
    </div>
    <div class="modal-body">
        <form [formGroup]="subscriptionForm">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Utilisateur</label>
                    <select class="form-select" formControlName="userId">
                        <option value="">Sélectionner un utilisateur</option>
                        <option *ngFor="let user of users" [value]="user.id">{{user.username}} ({{user.email}})</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Plan d'abonnement</label>
                    <select class="form-select" (change)="onPlanSelect($event)">
                        <option value="">Sélectionner un plan</option>
                        <option *ngFor="let plan of subscriptionPlans" [value]="plan.type">
                            {{plan.name}} ({{plan.price}} TND - {{plan.billingCycle === 'MONTHLY' ? 'Mensuel' : 'Annuel'}})
                        </option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Type d'abonnement</label>
                    <select class="form-select" formControlName="type">
                        <option value="">Sélectionner un type</option>
                        <option value="INDIVIDUAL">Individuel</option>
                        <option value="TEAM">Équipe</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Cycle de facturation</label>
                    <select class="form-select" formControlName="billingCycle">
                        <option value="">Sélectionner un cycle</option>
                        <option value="MONTHLY">Mensuel</option>
                        <option value="YEARLY">Annuel</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Nom</label>
                    <input type="text" class="form-control" formControlName="name">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Prix (TND)</label>
                    <input type="number" class="form-control" formControlName="price" min="0" step="0.01">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Date de début</label>
                    <input type="date" class="form-control" formControlName="startDate">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Date de fin</label>
                    <input type="date" class="form-control" formControlName="endDate">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Espaces max</label>
                    <input type="number" class="form-control" formControlName="maxWorkspaces" min="1">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Heures incluses</label>
                    <input type="number" class="form-control" formControlName="includedHours" min="0">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Tarif horaire (TND)</label>
                    <input type="number" class="form-control" formControlName="hourlyRate" min="0" step="0.01">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.hide()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="saveSubscription()">
            Mettre à jour
        </button>
    </div>
</ng-template>